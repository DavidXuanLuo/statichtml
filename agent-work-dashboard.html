<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>贾维斯实时工作看板（桌面版）</title>
  <style>
    :root { color-scheme: dark; }
    * { box-sizing: border-box; }
    body { margin:0; background:#0b1220; color:#e6edf3; font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"PingFang SC","Microsoft YaHei",sans-serif; }
    .wrap { max-width: 1360px; margin: 0 auto; padding: 18px; }
    .top { display:flex; justify-content:space-between; align-items:flex-end; gap:12px; margin-bottom:14px; }
    h1 { margin:0; font-size:24px; }
    .muted { color:#8aa0b6; font-size:13px; }
    .grid4 { display:grid; grid-template-columns: repeat(4, minmax(160px, 1fr)); gap:10px; margin-bottom:12px; }
    .card { background:#111b2e; border:1px solid #20314d; border-radius:12px; padding:12px; }
    .k { color:#90a7bd; font-size:12px; }
    .v { font-size:26px; font-weight:700; margin-top:3px; }
    .layout { display:grid; grid-template-columns: 1.3fr 1fr; gap:12px; }
    .section-title { font-size:15px; font-weight:700; margin-bottom:8px; }
    .list { margin:0; padding-left:18px; }
    .list li { margin:7px 0; line-height:1.45; }
    .badge { display:inline-block; padding:2px 8px; border-radius:999px; font-size:12px; border:1px solid #3a587c; color:#9fd2ff; }
    .ok { color:#7dd3a7; }
    .warn { color:#f8cc77; }
    .err { color:#ff8f8f; }
    table { width:100%; border-collapse: collapse; font-size:13px; }
    th, td { border-bottom:1px solid #20314d; padding:8px 6px; text-align:left; vertical-align:top; }
    th { color:#9db3c8; font-weight:600; }
    .status-running { color:#7dd3a7; }
    .status-pending { color:#f8cc77; }
    .status-disabled { color:#9aa8b6; }
    .footer { margin-top:10px; color:#7f93a8; font-size:12px; }
    @media (max-width: 1080px) {
      .layout { grid-template-columns: 1fr; }
      .grid4 { grid-template-columns: repeat(2, minmax(140px, 1fr)); }
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="top">
      <div>
        <h1 id="title">贾维斯实时工作看板（桌面版）</h1>
        <div class="muted" id="clock">--</div>
      </div>
      <div class="muted">自动刷新：<span id="refreshSec">--</span>s ｜ 数据源：<code>data/agent-work-status.json</code></div>
    </div>

    <div class="grid4">
      <div class="card"><div class="k">系统状态</div><div class="v" id="sStatus">--</div></div>
      <div class="card"><div class="k">今日已完成</div><div class="v" id="sDone">0</div></div>
      <div class="card"><div class="k">运行中任务</div><div class="v" id="sRunning">0</div></div>
      <div class="card"><div class="k">待执行任务</div><div class="v" id="sPending">0</div></div>
    </div>

    <div class="layout">
      <div>
        <div class="card" style="margin-bottom:12px;">
          <div class="section-title">当前进行中</div>
          <ul class="list" id="nowList"></ul>
        </div>

        <div class="card" style="margin-bottom:12px;">
          <div class="section-title">今日时间线（最新在前）</div>
          <ul class="list" id="timelineList"></ul>
        </div>

        <div class="card">
          <div class="section-title">已完成事项</div>
          <ul class="list" id="doneList"></ul>
        </div>
      </div>

      <div>
        <div class="card" style="margin-bottom:12px;">
          <div class="section-title">全任务排班（含停用）</div>
          <table>
            <thead>
              <tr>
                <th>任务</th><th>状态</th><th>频率</th><th>下次执行</th>
              </tr>
            </thead>
            <tbody id="schedBody"></tbody>
          </table>
        </div>

        <div class="card">
          <div class="section-title">阻塞/风险</div>
          <ul class="list" id="blockedList"></ul>
        </div>
      </div>
    </div>

    <div class="footer">最后更新：<span id="lastUpdated">--</span></div>
  </div>

<script>
  let refreshSeconds = 15;
  const h = (s='') => String(s).replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
  const n = v => Number(v||0).toLocaleString('zh-CN');

  function statusClass(s='') {
    s = String(s).toLowerCase();
    if (s.includes('running')) return 'status-running';
    if (s.includes('pending')) return 'status-pending';
    if (s.includes('disabled')) return 'status-disabled';
    return '';
  }

  async function load() {
    const res = await fetch(`./data/agent-work-status.json?t=${Date.now()}`);
    const d = await res.json();

    refreshSeconds = d.meta?.refreshSeconds || 15;
    document.getElementById('refreshSec').textContent = refreshSeconds;
    document.getElementById('title').textContent = d.meta?.title || '贾维斯实时工作看板（桌面版）';

    document.getElementById('sStatus').textContent = d.summary?.status || '--';
    document.getElementById('sDone').textContent = n(d.summary?.todayCompleted);
    document.getElementById('sRunning').textContent = n(d.summary?.todayRunning);
    document.getElementById('sPending').textContent = n(d.summary?.todayPending);

    const nowList = document.getElementById('nowList');
    nowList.innerHTML = '';
    (d.now || []).forEach(x => {
      const li = document.createElement('li');
      li.innerHTML = `<strong>${h(x.title||'')}</strong> <span class="badge">${h(x.status||'--')}</span><br>${h(x.progress||'')}<br><span class="muted">${h(x.detail||'')} ｜ 更新 ${h(x.updatedAt||'--')}</span>`;
      nowList.appendChild(li);
    });

    const timelineList = document.getElementById('timelineList');
    timelineList.innerHTML = '';
    (d.timeline || []).forEach(x => {
      const li = document.createElement('li');
      li.innerHTML = `<span class="muted">[${h(x.time||'--:--')}]</span> ${h(x.text||'')}`;
      timelineList.appendChild(li);
    });

    const doneList = document.getElementById('doneList');
    doneList.innerHTML = '';
    (d.completed || []).forEach(x => {
      const li = document.createElement('li');
      li.innerHTML = `<strong>${h(x.title||'')}</strong>：${h(x.result||'')} <span class="muted">(${h(x.updatedAt||'--')})</span>`;
      doneList.appendChild(li);
    });

    const schedBody = document.getElementById('schedBody');
    schedBody.innerHTML = '';
    (d.scheduled || []).forEach(x => {
      const tr = document.createElement('tr');
      const st = x.enabled ? (x.status || 'pending') : 'disabled';
      tr.innerHTML = `<td><strong>${h(x.name||'')}</strong><br><span class="muted">${h(x.scope||'')}</span></td><td class="${statusClass(st)}">${h(st)}</td><td>${h(x.cadence||'')}</td><td>${h(x.nextRun||'')}</td>`;
      schedBody.appendChild(tr);
    });

    const blockedList = document.getElementById('blockedList');
    blockedList.innerHTML = '';
    (d.blocked || []).forEach(x => {
      const li = document.createElement('li');
      li.innerHTML = `<strong class="warn">${h(x.title||'')}</strong><br><span class="muted">影响：</span>${h(x.impact||'')}<br><span class="muted">下一步：</span>${h(x.nextAction||'')}`;
      blockedList.appendChild(li);
    });

    document.getElementById('lastUpdated').textContent = d.meta?.lastUpdated || d.lastUpdated || '--';
    document.getElementById('clock').textContent = `本地时间：${new Date().toLocaleString('zh-CN')}（${d.meta?.timezone || 'Asia/Shanghai'}）`;
  }

  async function loop() {
    try { await load(); } catch (e) { document.getElementById('clock').textContent = '加载失败，将自动重试'; }
    setTimeout(loop, Math.max(5, refreshSeconds) * 1000);
  }
  loop();
</script>
</body>
</html>