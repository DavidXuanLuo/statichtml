<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>贾维斯实时工作看板（桌面版）</title>
  <style>
    body { margin:0; background:#0f1419; color:#e7ecf0; font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"PingFang SC","Microsoft YaHei",sans-serif; }
    .wrap { max-width: 1240px; margin: 0 auto; padding: 20px; }
    .top { display:flex; justify-content:space-between; align-items:flex-end; gap:12px; margin-bottom:14px; }
    h1 { margin:0; font-size:24px; }
    .muted { color:#8b98a5; font-size:13px; }
    .card { background:#17202a; border:1px solid #253341; border-radius:12px; padding:14px; margin-bottom:12px; }
    .grid { display:grid; grid-template-columns:repeat(4,minmax(120px,1fr)); gap:10px; }
    .k { font-size:12px; color:#8b98a5; }
    .v { font-size:24px; font-weight:700; margin-top:4px; }
    .two { display:grid; grid-template-columns:1.2fr 1fr; gap:12px; }
    .pill { display:inline-block; padding:2px 8px; border-radius:999px; font-size:12px; border:1px solid #2f4555; color:#9fd3ff; }
    .running { color:#56b8ff; }
    .pending { color:#f4c66a; }
    .disabled { color:#8b98a5; }
    ul { margin:8px 0 0; padding-left:18px; }
    li { margin:6px 0; line-height:1.45; }
    table { width:100%; border-collapse:collapse; font-size:13px; }
    th, td { padding:10px 8px; border-bottom:1px solid #253341; text-align:left; vertical-align:top; }
    th { color:#8b98a5; font-weight:600; }
    .nowrap { white-space:nowrap; }
    @media (max-width:1000px){ .two{grid-template-columns:1fr;} .grid{grid-template-columns:repeat(2,minmax(120px,1fr));} }
  </style>
</head>
<body>
<div class="wrap">
  <div class="top">
    <div>
      <h1 id="title">贾维斯实时工作看板（桌面版）</h1>
      <div class="muted" id="meta">加载中...</div>
    </div>
    <div class="muted" id="clock">--</div>
  </div>

  <div class="card grid">
    <div><div class="k">当前状态</div><div class="v" id="status">--</div></div>
    <div><div class="k">今日已完成</div><div class="v" id="done">0</div></div>
    <div><div class="k">进行中</div><div class="v" id="runningCount">0</div></div>
    <div><div class="k">待处理</div><div class="v" id="pending">0</div></div>
  </div>

  <div class="two">
    <div class="card">
      <strong>正在执行</strong>
      <ul id="now"></ul>
    </div>
    <div class="card">
      <strong>最新时间线</strong>
      <ul id="timeline"></ul>
    </div>
  </div>

  <div class="card">
    <strong>今日全部任务（运行中 / 待执行 / 停用）</strong>
    <div class="muted" style="margin-top:6px;">你关心的“还没到时间的定时任务”会在这里显示 nextRun。</div>
    <table style="margin-top:8px;">
      <thead>
        <tr>
          <th>任务</th><th>状态</th><th>频率</th><th>下次执行</th><th>范围</th>
        </tr>
      </thead>
      <tbody id="scheduledRows"></tbody>
    </table>
  </div>

  <div class="two">
    <div class="card">
      <strong>今日已完成</strong>
      <ul id="completed"></ul>
    </div>
    <div class="card">
      <strong>阻塞 / 风险</strong>
      <ul id="blocked"></ul>
    </div>
  </div>
</div>

<script>
const dataUrl = './data/agent-work-status.json';
const $ = id => document.getElementById(id);
function esc(s=''){return String(s).replace(/[&<>"']/g,m=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[m]));}
function renderList(el, list, map){ el.innerHTML = (list||[]).map(map).join('') || '<li class="muted">暂无</li>'; }
function sClass(s){ return s==='running'?'running':(s==='pending'?'pending':'disabled'); }
async function load(){
  const r = await fetch(dataUrl + '?t=' + Date.now(), {cache:'no-store'});
  const d = await r.json();

  $('title').textContent = d.meta?.title || '实时工作看板';
  $('meta').textContent = `最后更新：${d.meta?.lastUpdated || '--'} ｜ 时区：${d.meta?.timezone || '--'} ｜ 自动刷新：${d.meta?.refreshSeconds || 8}s`;
  $('status').textContent = d.summary?.status || '--';
  $('done').textContent = d.summary?.todayCompleted ?? 0;
  $('runningCount').textContent = d.summary?.todayRunning ?? 0;
  $('pending').textContent = d.summary?.todayPending ?? 0;

  renderList($('now'), d.now, i => `<li><b>${esc(i.title)}</b> <span class="pill">${esc(i.status||'')}</span><br><span class="muted">${esc(i.progress||'')}</span><br><span class="muted">${esc(i.detail||'')} · ${esc(i.updatedAt||'')}</span></li>`);
  renderList($('timeline'), d.timeline, i => `<li><span class="muted">[${esc(i.time||'--')} · ${esc(i.type||'--')}]</span><br>${esc(i.text||'')}</li>`);
  renderList($('completed'), d.completed, i => `<li><b>${esc(i.title)}</b><br><span class="muted">${esc(i.result||'')} · ${esc(i.updatedAt||'')}</span></li>`);
  renderList($('blocked'), d.blocked, i => `<li><b>${esc(i.title)}</b><br><span class="muted">影响：${esc(i.impact||'')}</span><br><span class="muted">下一步：${esc(i.nextAction||'')}</span></li>`);

  const rows = (d.scheduled||[]).map(i => `
    <tr>
      <td>${esc(i.name)}</td>
      <td class="${sClass(i.status)} nowrap">${esc(i.enabled ? (i.status||'running') : 'disabled')}</td>
      <td class="nowrap">${esc(i.cadence||'--')}</td>
      <td class="nowrap">${esc(i.nextRun||'--')}</td>
      <td>${esc(i.scope||'--')}</td>
    </tr>`).join('');
  $('scheduledRows').innerHTML = rows || '<tr><td colspan="5" class="muted">暂无任务</td></tr>';
}

function tickClock(){ $('clock').textContent = '本地时间：' + new Date().toLocaleString('zh-CN'); }
load().catch(()=>{$('meta').textContent='加载失败';});
setInterval(()=>load().catch(()=>{}), 8000);
setInterval(tickClock, 1000); tickClock();
</script>
</body>
</html>
